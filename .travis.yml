os:
    - linux

env:
    - TRAVIS_CI=TRAVIS_CI


language: python

sudo: true

cache:
    - pip
    - $HOME/virtualenv

python:
    - 3.4
    - 3.6

install:
    - pip install -r requirements.txt
    - pip install -r test_requirements.txt
    - python setup.py install
    - pip install codecov
#    - sudo apt update

script:
    - export BGMI_LOG=debug
    - export BANGUMI_1=名侦探柯南
    - export BANGUMI_2=黑色五叶草
    - export BANGUMI_3=海贼王
    - coverage run -a -m bgmi.main install
    - bgmi -h
    - coverage run -a -m unittest
    - cp tests/test_script.py $HOME/.bgmi/scripts/test_script.py
    - coverage run -a -m bgmi.main gen nginx.conf --server-name _
    - coverage run -a -m bgmi.main cal -f
    - coverage run -a -m bgmi.main config
    - coverage run -a -m bgmi.main config ADMIN_TOKEN 233
    - coverage run -a -m bgmi.main config DOWNLOAD_DELEGATE 'aria2-rpc'
    - coverage run -a -m bgmi.main config BANGUMI_MOE_URL https://bangumi.moe
    - coverage run -a -m bgmi.main add $BANGUMI_1 $BANGUMI_2 $BANGUMI_3
    - coverage run -a -m bgmi.main update
    - coverage run -a -m bgmi.main delete --name $BANGUMI_3
    - coverage run -a -m bgmi.main delete --clear-all --batch
    - coverage run -a -m bgmi.main add $BANGUMI_2 --episode 1
    - coverage run -a -m bgmi.main fetch $BANGUMI_2
    - coverage run -a -m bgmi.main list
    # - coverage run -a -m bgmi.main download --list
    - coverage run -a -m bgmi.main mark $BANGUMI_2 1
    - coverage run -a -m bgmi.main update $BANGUMI_2
    - coverage run -a -m bgmi.main filter $BANGUMI_2 --subtitle "" --exclude "MKV" --regex "720p|720P"
    - coverage run -a -m bgmi.main fetch $BANGUMI_2
    # - coverage run -a -m unittest tests.test_http_api
    - coverage run -a -m bgmi.main search "海贼王" --regex-filter '.*MP4.*720P.*'
    - eval "$(coverage run -a -m bgmi.main complete)"

after_success:
  - codecov
