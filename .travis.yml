language: python

branches:
  only:
    - master
    - dev

python:
  - "3.6"

os: linux

dist: xenial

cache:
  pip: true
  directories:
    - /c/python36
    - $HOME/.cache/pip
    - $HOME/AppData/Local/pip/Cache
    - $HOME/Library/Caches/pip
    - $HOME/Library/Caches/Homebrew
    - $HOME/choco/cache
    - $HOME/.cache/pre-commit

env:
  global:
    - PYTHONIOENCODING=utf-8
    - PYTHONUTF8=1
    - TRAVIS_CI=TRAVIS_CI

services:
  - mysql
  - docker

stages:
  - test
  - name: deploy
    if: branch = master

jobs:
  include:
    - stage: test
    - os: osx
      name: 'test python3.6 on MacOS'
      language: generic
      python: "3.6"
      env:
        - TRAVIS_PYTHON_VERSION=3.6

    - os: windows
      language: sh
      python: "3.6"
      name: 'test python3.6 on Windows'
      env:
        - TRAVIS_PYTHON_VERSION=3.6

before_cache:
  - rm -f $HOME/.cache/pip/log/debug.log

before_install:
  - |
    if [[ $TRAVIS_OS_NAME == "osx" ]]; then
      bash .ci/install_python_on_osx.bash
      source $HOME/venv/bin/activate
    fi
  - |
    if [[ $TRAVIS_OS_NAME == "windows" ]]; then
      if [ -z "$(ls -A /c/Python36)" ]; then

        choco config set cacheLocation $HOME/choco/cache

        if [[ $TRAVIS_PYTHON_VERSION == "3.7" ]];then
          choco install python --version 3.7.3
        elif [[ $TRAVIS_PYTHON_VERSION == '3.6' ]];then
          choco install python --version 3.6.8
        else
          travis_terminate
        fi
      fi

      export LANG=en_US.UTF-8
      v=$TRAVIS_PYTHON_VERSION
      export PATH="/c/Python${v/./}:/c/Python${v/./}/Scripts:$PATH"

      python -m pip install --upgrade pip wheel;

      python -m venv ~/venv
      source ~/venv/Scripts/activate
    fi

install:
  - chmod +x .ci/install.bash
  - ./.ci/install.bash

script:
  - export DB_SQL_PATH=~/data/db.sql

  - bash .ci/script.bash

  - |
    bash ./.ci/command_test.bash

    codecov --flags command > /dev/null
    rm .coverage codecov.yml -f||true

after_success:
  - codecov
