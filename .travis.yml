language: python

os:
  - linux
dist: xenial

env:
  global:
    - TRAVIS_CI=TRAVIS_CI
    - BGMI_LOG=debug
    - BANGUMI_1=名侦探柯南
    - BANGUMI_2=刃牙
    - BANGUMI_3=海贼王
  matrix:
    - DB=sqlite
    - DB=mysql

services:
  - mysql

cache:
  directories:
    - /home/travis/virtualenv/

python:
  - 3.4
  - 3.6

#before_install:
#  - if [[ "$DB" == "mysql" ]]; then mysql -e 'CREATE DATABASE IF NOT EXISTS test DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_general_ci;'; fi

install:
  - pip install -r requirements.txt
  - pip install -r test_requirements.txt
  - python setup.py install
  - if [[ "$DB" == "mysql" ]]; then pip install pymysql; fi
  - pip install codecov
  - pip install python-Levenshtein

script:
  - coverage run -a -m bgmi.main
  - cp tests/test_script.py $HOME/.bgmi/scripts/test_script.py

  - bash tests/init_env_and_run_unit_test.sh test_website
  - bash tests/init_env_and_run_unit_test.sh test_utils
  - bash tests/init_env_and_run_unit_test.sh test_models
  - bash tests/init_env_and_run_unit_test.sh test_data_source
  - bash tests/init_env_and_run_unit_test.sh test_controllers
  - bash tests/init_env_and_run_unit_test.sh test_config
  - bash tests/init_env_and_run_unit_test.sh test_download_delegate
  - bgmi cal
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_http_api -v

  - rm ~/.bgmi -rf

  - coverage run -a -m bgmi.main install
  - bgmi -h

  - cp tests/test_script.py $HOME/.bgmi/scripts/test_script.py
  - coverage run -a -m bgmi.main gen nginx.conf --server-name _
  - if [[ "$DB" == "mysql" ]]; then bgmi config DB_URL 'mysql+pool://root:@127.0.0.1:3306/bgmi?charset=utf8mb4';bgmi install; fi

  - coverage run -a -m bgmi.main cal -f
  - coverage run -a -m bgmi.main config
  - coverage run -a -m bgmi.main config ADMIN_TOKEN 233
  - coverage run -a -m bgmi.main config DOWNLOAD_DELEGATE 'aria2-rpc'
  - coverage run -a -m bgmi.main add $BANGUMI_1 $BANGUMI_2 $BANGUMI_3
  - coverage run -a -m bgmi.main update
  - coverage run -a -m bgmi.main delete --name $BANGUMI_3
  - coverage run -a -m bgmi.main delete --clear-all --batch
  - coverage run -a -m bgmi.main add $BANGUMI_2 --episode 1
  - coverage run -a -m bgmi.main fetch $BANGUMI_2
  - coverage run -a -m bgmi.main list

  - coverage run -a -m bgmi.main mark $BANGUMI_2 1
  - coverage run -a -m bgmi.main update $BANGUMI_2
  - coverage run -a -m bgmi.main filter $BANGUMI_2 --subtitle "" --exclude "MKV" --regex "720p|720P"
  - coverage run -a -m bgmi.main fetch $BANGUMI_2

  - coverage run -a -m bgmi.main search "海贼王" --regex-filter '.*MP4.*720P.*' --min-episode 800 --max-episode 900

  - eval "$(coverage run -a -m bgmi.main complete)"

after_success:
  - codecov
