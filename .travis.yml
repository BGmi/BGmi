language: python

os:
  - linux

env:
  matrix:
    - DB=sqlite
    - DB=mysql

services:
  - mysql


cache:
  directories:
    - /home/travis/virtualenv/

python:
  - 3.4
  - 3.6

before_install:
  - mysql -e 'CREATE DATABASE IF NOT EXISTS test;'
  - sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('new_password') where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"
  - sudo service mysql restart

install:
  - pip install -r requirements.txt
  - pip install -r test_requirements.txt
  - python setup.py install
  - if [[ "$DB" == "mysql" ]]; then pip install pymysql; fi
  - pip install codecov
  - pip install python-Levenshtein
#    - sudo apt update

script:
  - export TRAVIS_CI=TRAVIS_CI
  - export BGMI_LOG=debug
  - export BANGUMI_1=名侦探柯南
  - export BANGUMI_2=刃牙
  - export BANGUMI_3=海贼王
  - coverage run -a -m bgmi.main install
  - bgmi -h
  - mv tests/test_script.py $HOME/.bgmi/scripts/test_script.py

  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_website -v
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_utils -v
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_models -v
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_data_source -v
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_controllers -v
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_config -v
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_download_delegate -v
  - UNITTEST=1 BGMI_LOG=info coverage run -a -m unittest tests.test_http_api -v

  - coverage run -a -m bgmi.main gen nginx.conf --server-name _

  - coverage run -a -m bgmi.main cal -f
  - coverage run -a -m bgmi.main config

  - if [[ "$DB" == "mysql" ]]; then bgmi config DB_URL 'mysql+pool://root:new_password@127.0.0.1:3306/test'; fi

  - coverage run -a -m bgmi.main config ADMIN_TOKEN 233
  - coverage run -a -m bgmi.main config DOWNLOAD_DELEGATE 'aria2-rpc'
  - coverage run -a -m bgmi.main add $BANGUMI_1 $BANGUMI_2 $BANGUMI_3
  - coverage run -a -m bgmi.main update
  - coverage run -a -m bgmi.main delete --name $BANGUMI_3
  - coverage run -a -m bgmi.main delete --clear-all --batch
  - coverage run -a -m bgmi.main add $BANGUMI_2 --episode 1
  - coverage run -a -m bgmi.main fetch $BANGUMI_2
  - coverage run -a -m bgmi.main list

  - coverage run -a -m bgmi.main mark $BANGUMI_2 1
  - coverage run -a -m bgmi.main update $BANGUMI_2
  - coverage run -a -m bgmi.main filter $BANGUMI_2 --subtitle "" --exclude "MKV" --regex "720p|720P"
  - coverage run -a -m bgmi.main fetch $BANGUMI_2

  - coverage run -a -m bgmi.main search "海贼王" --regex-filter '.*MP4.*720P.*' --min-episode 800 --max-episode 900

  - eval "$(coverage run -a -m bgmi.main complete)"

after_success:
  - codecov
